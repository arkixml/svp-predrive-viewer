<!DOCTYPE HTML>
<html>
<head>
<title>SVP Predrive Viewer</title>
<style type="text/css">
#events {
  border: 1px solid black;
  width: 640px;
  height: 480px;
  overflow: auto;
}
.event {
  border: 2px solid gray;
  border-radius: 8px;
  height: 50px;
  margin: 2px;
  padding: 5px;
}
.speed {
  float: right;
  font-size: 40px;
}
.comment {
  float: right;
}
.passed {
  background-color: lightgray;
  color: darkgray;
}
.soon {
  border: 2px solid blue;
}
.verysoon {
  border: 2px solid red;
}
</style>
<script src="jquery-2.1.0.min.js"></script>
<script>
var lines;
$.ajax("gps/gpsdData").done(function(data) {
  $('#loading').html('Parsing...');
  lines = data.split('\n');
  $('#loading').html('');
  loadPointData();
});
var eventList = []
function loadPointData() {
  $.ajax("gps/poidata").done(function(data) {
    var events = data.split('\n');
    for (eventnum in events) {
      var eventText = events[eventnum].split(',');
      var event = [];
      event.type = eventText[0];
      event.time = eventText[1];
      event.meta = eventText[5];
      var eventElement = $('<div>');
      event.element = eventElement;
      eventList.push(event);
      eventElement.addClass('event');
      var eventNameElement = $('<span>');
      eventNameElement.html(event.type);
      eventNameElement.appendTo(eventElement);
      if (event.type == 'SPEED') {
        var eventSpeedElement = $('<span>');
	eventSpeedElement.addClass('speed');
	eventSpeedElement.html(event.meta);
	eventSpeedElement.appendTo(eventElement);
      }
      if (event.type == 'COMMENT') {
        var eventSpeedElement = $('<span>');
	eventSpeedElement.addClass('comment');
	eventSpeedElement.html(event.meta);
	eventSpeedElement.appendTo(eventElement);
      }
      eventElement.appendTo($('#events'));
    }
    advance();
  });
};
var currentLine = 0;
var autoEnabled = 0;
var speed = 1000;
function advance() {
  currentLine += 1;
  redraw();
  if (autoEnabled) {
    setTimeout(advance, speed);
  }
}
function auto() {
  speed = 1000;
  if (!autoEnabled) {
    autoEnabled = 1;
    advance();
  }
}
function turbo() {
  speed = 100;
  if (!autoEnabled) {
    autoEnabled = 1;
    advance();
  }
}
function redraw() {
  $("#line").html(lines[currentLine]);
  var data = lines[currentLine].split(',');
  var time = data[0];
  var longitude = data[5];
  var latitude = data[6];
  $('#time').html(time);
  $('#longitude').html(longitude);
  $('#latitude').html(latitude);
  var date = new Date(time);
  var nextEventDate = new Date(eventList[0].time);
  if ((nextEventDate.getTime() - date.getTime()) < 60000) {
    eventList[0].element.addClass('soon');
  }
  if ((nextEventDate.getTime() - date.getTime()) < 10000) {
    eventList[0].element.removeClass('soon');
    eventList[0].element.addClass('verysoon');
  }
  if (date.getTime() > nextEventDate.getTime()) {
    eventList[0].element.removeClass('soon');
    eventList[0].element.removeClass('verysoon');
    eventList[0].element.addClass('passed');
    eventList.shift();
    eventList[2].element[0].scrollIntoView(false);
  }
  var filename = time.replace(/:/g,'_') + ',' + longitude + ',' + latitude + '.jpg';
  $('#image').attr('src','gps/'+filename);
}  
</script>
</head>
<body>
<p><img id="image"></img><div id="events"></div></p>
<span id="loading">Loading...</span>
<p>Time:<span id="time"></span></p>
<p>Longitude:<span id="longitude"></span></p>
<p>Latitude:<span id="latitude"></span></p>
<br>
<button onClick="advance()">Next</button>
<button onClick="auto()">Auto</button>
<button onClick="turbo()">Turbo</button>
</body>
</html>